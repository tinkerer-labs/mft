[env]
MFT_CONFIG = "./mft.yaml"

[tools]
go = "1.26"

[tasks.run]
alias = "r"
description = "Build with air"
run = "go run ./cmd/mft/main.go"

[tasks.test]
description = "Test all"
run = "go test ./..."

[tasks.coverage]
alias = "cov"
description = "Affiche le r√©sum√© du coverage dans la console"
run = "go test -cover ./..."

[tasks.coverage_report]
alias = "cr"
description = "G√©n√®re le profil et v√©rifie le seuil de couverture"
run = """
set -e
go test -coverprofile=coverage.out ./...
TOTAL_COV=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
echo "Couverture actuelle : $TOTAL_COV%"

if awk "BEGIN {exit !($TOTAL_COV < $COVERAGE_THRESHOLD)}"; then
    echo "√âCHEC : couverture ${TOTAL_COV}% inf√©rieure au seuil ${COVERAGE_THRESHOLD}%"
    exit 1
fi
echo "Seuil respect√© : ${TOTAL_COV}%"
"""

[tasks.coverage_view]
alias = "cv"
description = "Ouvre le rapport de couverture dans le navigateur"
depends = ["coverage_report"]
run = "go tool cover -html=coverage.out"

[tasks.commit]
alias = "c"
description = "Commit interactif aux normes Pro"
run = "commitizen-go"

[tasks.changelog]
alias = "log"
description = "G√©n√®re ou met √† jour le fichier CHANGELOG.md"
run = "git-chglog -o CHANGELOG.md"

[tasks.setup]
description = "Installe les outils et configure les hooks"
run = """
set -e
echo "üì• Installation de commitizen-go..."
go install github.com/lintingzhen/commitizen-go@latest

echo "üì• Installation de git-chglog..."
go install github.com/git-chglog/git-chglog/cmd/git-chglog@latest

echo "‚öì Configuration des Git Hooks..."
git config core.hooksPath .githooks

echo "üì¶ Nettoyage des modules Go..."
go mod tidy

echo "‚úÖ Setup termin√© !"
"""


[tasks.release]
description = "Cr√©e une nouvelle version (changelog + tag)"
run = """
set -e

echo "Entrez la nouvelle version (ex: v1.0.1) :"
read VERSION

git-chglog -o CHANGELOG.md --next-tag "$VERSION"

git add CHANGELOG.md
git commit -m "chore(docs): update changelog for $VERSION"

git tag "$VERSION"
echo "‚úÖ Version $VERSION cr√©√©e avec succ√®s !"
echo "N'oubliez pas de faire : git push origin main --tags"
"""
